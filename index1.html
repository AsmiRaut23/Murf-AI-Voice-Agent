<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kampra AI</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container card">
    <h1>Kampra AI</h1>
    <p class="subtitle"> AI Conversational Partner</p>

    <div class="voice-select">
      <label for="voice">Select a Voice:</label>
      <select id="voice">
        <option value="en-US-natalie">Natalie (female)</option>
        <option value="en-US-jake">Jake (male)</option>
        <option value="en-GB-sophia">Sophia (female)</option>
        <option value="en-IN-raj">Raj (male)</option>
      </select>
    </div>

    <div class="mic-area">
      <button id="recordBtn" class="mic-btn" aria-label="Record">
        <span class="mic-icon"><img src="/static/mic.png" alt="mic"></span>
      </button>
      <div class="status-dot" id="statusDot"></div>
      <p id="status">Ready</p>
    </div>

    <div id="chatBox" class="chat-box"></div>

    <!-- hidden player: audio auto-plays -->
    <audio id="responseAudio" style="display:none;"></audio>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let recording = false;
    const sessionId = Date.now().toString();

    const recordBtn = document.getElementById('recordBtn');
    const statusEl = document.getElementById('status');
    const statusDot = document.getElementById('statusDot');
    const voiceSel = document.getElementById('voice');
    const chatBox = document.getElementById('chatBox');
    const responseAudio = document.getElementById('responseAudio');

    const setStatus = (msg, isError=false) => {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? '#ff6b6b' : '#cfd8dc';
    };

    const addMsg = (who, text) => {
      if (!text) return;
      const div = document.createElement('div');
      div.className = who === 'user' ? 'bubble user' : 'bubble ai';
      div.textContent = (who === 'user' ? 'You: ' : 'Kampra AI: ') + text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    // recordBtn.addEventListener('click', () => {
    //   if (!recording) startRecording();
    //   else stopRecording();
    // });

    recordBtn.addEventListener('click', () => {
  if (!recording) {
    startRecording();
    recordBtn.classList.add('recording'); // start animation
    console.log("Recording started");
  } else {
    stopRecording();
    recordBtn.classList.remove('recording'); // stop animation
    console.log("Recording stopped");
  }
});


    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => { if (e.data.size) audioChunks.push(e.data); };
          mediaRecorder.onstop = onStopped;
          mediaRecorder.start();

          recording = true;
          recordBtn.classList.add('recording');
          statusDot.classList.add('on');
          setStatus('Listening…');
        })
        .catch(err => {
          console.error('Mic error:', err);
          setStatus('Microphone access denied', true);
        });
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        recording = false;
        recordBtn.classList.remove('recording');
        statusDot.classList.remove('on');
        setStatus('Processing…');
      }
    }

    function onStopped() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const form = new FormData();
      form.append('audio', blob, 'input.webm');
      form.append('voice_id', voiceSel.value);

      fetch(`/agent/chat/${sessionId}`, { method: 'POST', body: form })
        .then(async res => {
          const transcript = res.headers.get('X-Transcript') || '';
          const reply = res.headers.get('X-Reply') || '';

          if (transcript) addMsg('user', transcript);
          if (reply) addMsg('ai', reply);

          if (!res.ok) throw new Error('Server error');

          const audioBlob = await res.blob();
          const url = URL.createObjectURL(audioBlob);
          responseAudio.src = url;
          responseAudio.play();

          setStatus('Ready');
        })
        .catch(err => {
          console.error(err);
          addMsg('ai', "I'm having trouble connecting right now.");
          setStatus('Trouble connecting', true);
        });
    }
  </script>
</body>
</html>

